---
- name: prepare hosts
  hosts: all
  remote_user: ubuntu
  vars:
    zuul_user: zuul
    zuul_host: zuul01.osism.xyz
    zuul_logserver_fqdn: logs.osism.xyz
    zuul_webserver_fqdn: zuul.osism.xyz
    zuul_webserver_admin: info@osism.tech
    github_app_id: 180718
    github_pem_name: osism-zuul-app
    webhook_token: webhooksecretvalue  # set me from command line
    db_user_pass: userpassword         # set me from command line
    db_root_pass: rootpassword         # set me from command line
  pre_tasks:
    - name: update all packages
      ansible.builtin.apt:
        update_cache: true
        name: '*'
        state: latest
      become: true

    - name: install required packages
      ansible.builtin.apt:
        name:
          - apt-transport-https
          - docker.io
          - docker-compose
          - python3-docker
          - python3-openstackclient
      become: true
    
    - name: add user to docker group
      ansible.builtin.user:
        name: "{{ ansible_ssh_user }}"
        groups: docker
        append: true
      become: true

    - name: add group
      ansible.builtin.group:
        name: "{{ zuul_user }}"
      become: true

    - name: add user
      ansible.builtin.user:
        name: "{{ zuul_user }}"
        uid: 10001
        shell: /bin/bash
        group: "{{ zuul_user }}"
        groups: sudo
        append: true
        home: "/home/{{ zuul_user }}"
      become: true

    - name: Create /etc/openstack/
      ansible.builtin.file:
        state: directory
        path: /etc/openstack
        owner: root
        group: root
        mode: 0755
      become: true

    - name: Deploy clouds.yaml file
      ansible.builtin.copy:
        src: clouds.yaml
        dest: /etc/openstack/clouds.yaml
        owner: root
        group: zuul
        mode: '0640'
      become: true
    
    - name: Create keypair in the cloud
      openstack.cloud.keypair:
        cloud: osism-ci
        name: osism-zuul
        public_key: "{{ lookup('file', 'nodepool.pub') }}"
      become: true

  roles:
    - name: zuul-setup role
      role: zuul
      vars:
        operator_user: "{{ zuul_user }}"
        zookeeper_fqdn: zookeeper01.osism.xyz
        connections:
          github:
            driver: github
            webhook_token: "{{ webhook_token }}"
            app_id: "{{ github_app_id }}"
            app_key: "/etc/zuul/pem-files/{{ github_pem_name }}.pem"
          opendevorg:
            name: opendev
            driver: git
            baseurl: https://opendev.org
        tenants:
          - tenant:
              name: osism
              exclude-unprotected-branches: true
              source:
                opendevorg:
                  untrusted-projects:
                    - zuul/zuul-jobs:
                        include:
                          - job
                github:
                  config-projects:
                    - osism/zuul-config:
                        load-branch: main
                  untrusted-projects:
                    - osfrickler/cirros
                    - osfrickler/testbed
                    - osism/ansible-collection-commons
                    - osism/ansible-collection-services
                    - osism/ansible-collection-validations
                    - osism/ansible-defaults
                    - osism/ansible-lint-action
                    - osism/ansible-playbooks
                    - osism/container-image-ceph-ansible
                    - osism/container-image-inventory-reconciler
                    - osism/container-image-kolla-ansible
                    - osism/container-image-osism-ansible
                    - osism/container-image-uyuni
                    - osism/container-images
                    - osism/container-images-kolla
                    - osism/documentation
                    - osism/mappings
                    - osism/python-osism
                    - osism/release
                    - osism/testbed
                    - osism/zuul-jobs
        database:
          user_name: zuul
          user_pass: "{{ db_user_pass }}"
          root_pass: "{{ db_root_pass }}"
          db_name: zuul
        nodepool_labels:
          elements-dir: /srv/nodepool/elements
          labels:
            - name: ubuntu-focal
            - name: ubuntu-jammy
            - name: static-testbed
          diskimages:
            - name: base
              abstract: True
              elements:
                - vm
                - simple-init
                - growroot
                - infra-package-needs
                - zuul-worker
              env-vars:
                TMPDIR: /srv/dib_tmp
                ZUUL_USER_SSH_PUBLIC_KEY: |
                  ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAACAQDyCU/YncItaW8asyKb/vJr0T+VIfFWvKfyqeenmZcMzY9lJ7SbYz0I+81pfAxgBIDpiPBs6M6p2r4cumkzuazjMPK0o8k32uZgnIdE8l51+Fdhf1U0ejhiLhhMlP129im20wp9uf0U5KrzZ07aRT6UDV2hT85qizPMPcwyIy6zCFtG8ac+OIyHjICHz/j3toK99UGcpmz9bxzM3cZ9+Xo9HtizzAXzAbO+MPRGe7342GUcBQPl51ZPw0wu3+OSDgXRNAvQZn4KP5GCJhaTgykVsuEtEwnPD4R4+PbVOsihIIlVhSk5dA98+Ghda3ibFuD+BHvBu6uLtEy6oGWgHxRUdoRkGFg2ItAdjTe4FfTobuaAeGPyHLCmbyUMCKTLF0zvZhgayuzjy0oHw6N/OMXMFkPD6g3zt+9TwTqoOjsXex2usTrNnfmO6ml0yeyfWoR7Air1dHrXmrz3MDniSu0/vaxKSirzzev4UeKkJyobJ87uL1ebQ42mBFhv98dD1Bqzx8Bm4OTSADSrwtGaSw9KXvQ+R+r7oC4JuXJP/LKGQAh7wfNnkUabgSgSJaC6aVADo0qTFnVnd1SqA/0oOaV0RyUK6mAZv9+FIVlPTVtNijdsJf5NWuuKhLrH51DJqBZpGblTvNcFsi5AxDLyZZgIrzfSgYs8xVDUW6HRvYW7mw== zuul-nodepool-worker-key
                DIB_CHECKSUM: '1'
                DIB_IMAGE_CACHE: /srv/dib_cache
          
            - name: ubuntu-focal
              parent: base
              pause: false
              rebuild-age: 86400
              elements:
                - ubuntu-minimal
              release: focal
              username: zuul
              env-vars:
                DIB_APT_LOCAL_CACHE: '0'
                DIB_DISABLE_APT_CLEANUP: '0'
                FS_TYPE: ext3
            - name: ubuntu-jammy
              elements:
               - ubuntu-minimal
              env-vars:
                DIB_APT_LOCAL_CACHE: '0'
                DIB_DISABLE_APT_CLEANUP: '0'
                FS_TYPE: ext3
              parent: base
              pause: false
              rebuild-age: 86400
              release: jammy
              username: zuul


        nodepool_providers:
          providers:  # we need this sub-key. limitation of to_nice_yaml library
            - name: betacloud
              driver: openstack
              cloud: osism-ci
              boot-timeout: 600
              diskimages:
                - name: ubuntu-focal
                - name: ubuntu-jammy
              pools:
                - name: main
                  networks:
                    - net-to-external-osism-ci
                  security-groups:
                    - zuul-worker-node
                  max-servers: 3
                  labels:
                    - name: ubuntu-focal
                      min-ram: 4000
                      diskimage: ubuntu-focal
                      key-name: osism-zuul
                      console-log: true
                    - name: ubuntu-jammy
                      min-ram: 4000
                      diskimage: ubuntu-jammy
                      key-name: osism-zuul
                      console-log: true
            - name: static-testbed
              driver: static
              pools:
                - name: betacloud
                  nodes:
                    - name: 81.163.192.170
                      labels: static-testbed
                      username: ubuntu
                      host-key: "ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIC45EcO6trhIAFXO+zgOlqe8Sgm0iMhCh5h0xx+eDewJ"
      become: true
